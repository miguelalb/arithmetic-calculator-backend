service: arithmetic-calculator-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.9
  stage: ${opt:stage, 'dev'}
  apiGateway:
    request:
      schemas:
        ${file(./api/schema-definitions.yml)}

plugins:
  - serverless-python-requirements
  - serverless-stack-output

custom:
  pythonRequirements:
    layer: true
    useDownloadCache: false
    useStaticCache: false
  defaultCallBackURL:
    dev: "http://localhost:8080/callback"
    prod: "http://example.com/callback" # TODO CHANGE ME BEFORE DEPLOY TO PRODUCTION
  defaultSignOutURL:
    dev: "http://localhost:8080/logout"
    prod: "http://example.com/logout" # TODO CHANGE ME BEFORE DEPLOY TO PRODUCTION
  callBackUrls:
    dev:
      - ${self:custom.defaultCallBackURL.dev}
    prod:
      - ${self:custom.defaultCallBackURL.prod}
  signOutURLs:
    dev:
      - ${self:custom.defaultSignOutURL.dev}
    prod:
      - ${self:custom.defaultSignOutURL.prod}
  tableName: ${self:service}-${sls:stage}-ArithmeticCalculatorTable
  output:
    handler: scripts/output.handler
    file: env.json

package:
  individually: true  # Package each function individually
  patterns:  # Excluding some folders during function packaging
    - "!node_modules/**"
    - "!scripts/**"
    - "!.tox/**"
    - "!tox.ini"
    - "!**/.coverage"
    - "!**/__pycache__/**"
    - "!**/env/**"
    - "!**/.env/**"
    - "!**/tests/**"
    - "!regression/**"
    - "!schema_validators/**"
    - "!.serverless/**"
    - "!.github/**"
    - "!.env/**"
    - "!env.json"
    - "!README.md"
    - "!ArithmeticCalculatorArchitectureDiagram.png"
    - "!package.json"
    - "!package-lock.json"
    - "!resources.yml"
    - "!api/**"


functions:
  NewOperation:
    handler: lambdas.new_operation.main.handler
    memorySize: 256
    layers:
      - Ref: PythonRequirementsLambdaLayer
    environment: ${file(./lambdas/new_operation/env.yml):${opt:stage, self:provider.stage}}
    role:
       Fn::GetAtt:
        - NewOperationLambdaRole
        - Arn
    events:
      - http:
          path: /new-operation
          method: post
          request:
            schemas:
              application/json: new-operation-model

  hello:
    handler: handler.hello
    layers:
      - Ref: PythonRequirementsLambdaLayer
    events:
      - http:
          path: /hello
          method: get

  helloAuthRequired:
    handler: hello_auth_required.hello
    layers:
      - Ref: PythonRequirementsLambdaLayer
    events:
      - http:
          path: /hello-auth
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ArithmeticCalculatorAuthorizer

resources:
  ${file(./resources.yml)}
